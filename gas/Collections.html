<!DOCTYPE html>
<!--
  Collections.html - Vista de Cobranzas con Bandejas
  Adiction Boutique Suite
  
  Muestra cuotas pendientes organizadas en bandejas: Vencidas, Hoy, Esta Semana.
  Permite registrar pagos directamente desde la vista.
  
  Requisitos: 9.1
-->
<html lang="es-PE">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cobranzas - Adiction Boutique</title>
  
  <!-- Bootstrap 5.3 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.min.css">
  
  <!-- DataTables Bootstrap 5 CSS -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
  
  <style>
    .overdue-row {
      background-color: #fff5f5 !important;
    }
    
    .today-row {
      background-color: #fffbeb !important;
    }
    
    .summary-card {
      border-left: 4px solid;
    }
    
    .summary-card.overdue {
      border-left-color: #dc3545;
    }
    
    .summary-card.today {
      border-left-color: #ffc107;
    }
    
    .summary-card.week {
      border-left-color: #0dcaf0;
    }
  </style>
</head>
<body>
  
  <div class="container-fluid py-4">
    
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2><i class="bi bi-cash-coin"></i> Gestión de Cobranzas</h2>
      <button type="button" class="btn btn-outline-secondary" onclick="refreshAllTables()">
        <i class="bi bi-arrow-clockwise"></i> Actualizar
      </button>
    </div>
    
    <!-- Alert Container -->
    <div id="alertContainer"></div>
    
    <!-- Summary Cards -->
    <div class="row mb-4">
      <div class="col-md-4">
        <div class="card summary-card overdue">
          <div class="card-body">
            <h6 class="text-muted mb-2">Cuotas Vencidas</h6>
            <h3 class="mb-0" id="overdueCount">0</h3>
            <small class="text-muted">Total: <span id="overdueAmount">S/ 0.00</span></small>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card summary-card today">
          <div class="card-body">
            <h6 class="text-muted mb-2">Vencen Hoy</h6>
            <h3 class="mb-0" id="todayCount">0</h3>
            <small class="text-muted">Total: <span id="todayAmount">S/ 0.00</span></small>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card summary-card week">
          <div class="card-body">
            <h6 class="text-muted mb-2">Vencen Esta Semana</h6>
            <h3 class="mb-0" id="weekCount">0</h3>
            <small class="text-muted">Total: <span id="weekAmount">S/ 0.00</span></small>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Tabs for Collection Trays -->
    <ul class="nav nav-tabs mb-3" id="collectionTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="overdue-tab" data-bs-toggle="tab" 
                data-bs-target="#overdue" type="button" role="tab">
          <i class="bi bi-exclamation-triangle text-danger"></i> Vencidas
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="today-tab" data-bs-toggle="tab" 
                data-bs-target="#today" type="button" role="tab">
          <i class="bi bi-calendar-event text-warning"></i> Hoy
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="week-tab" data-bs-toggle="tab" 
                data-bs-target="#week" type="button" role="tab">
          <i class="bi bi-calendar-week text-info"></i> Esta Semana
        </button>
      </li>
    </ul>
    
    <div class="tab-content" id="collectionTabContent">
      
      <!-- Overdue Tab -->
      <div class="tab-pane fade show active" id="overdue" role="tabpanel">
        <div class="card">
          <div class="card-header bg-danger text-white">
            <h5 class="mb-0"><i class="bi bi-exclamation-triangle"></i> Cuotas Vencidas</h5>
          </div>
          <div class="card-body">
            <table id="overdueTable" class="table table-striped table-hover">
              <thead>
                <tr>
                  <th>Cliente</th>
                  <th>Plan</th>
                  <th>Cuota</th>
                  <th>Monto</th>
                  <th>Pagado</th>
                  <th>Saldo</th>
                  <th>Vencimiento</th>
                  <th>Días Vencido</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                <!-- Data will be loaded via AJAX -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
      
      <!-- Today Tab -->
      <div class="tab-pane fade" id="today" role="tabpanel">
        <div class="card">
          <div class="card-header bg-warning">
            <h5 class="mb-0"><i class="bi bi-calendar-event"></i> Cuotas que Vencen Hoy</h5>
          </div>
          <div class="card-body">
            <table id="todayTable" class="table table-striped table-hover">
              <thead>
                <tr>
                  <th>Cliente</th>
                  <th>Plan</th>
                  <th>Cuota</th>
                  <th>Monto</th>
                  <th>Pagado</th>
                  <th>Saldo</th>
                  <th>Vencimiento</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                <!-- Data will be loaded via AJAX -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
      
      <!-- Week Tab -->
      <div class="tab-pane fade" id="week" role="tabpanel">
        <div class="card">
          <div class="card-header bg-info text-white">
            <h5 class="mb-0"><i class="bi bi-calendar-week"></i> Cuotas que Vencen Esta Semana</h5>
          </div>
          <div class="card-body">
            <table id="weekTable" class="table table-striped table-hover">
              <thead>
                <tr>
                  <th>Cliente</th>
                  <th>Plan</th>
                  <th>Cuota</th>
                  <th>Monto</th>
                  <th>Pagado</th>
                  <th>Saldo</th>
                  <th>Vencimiento</th>
                  <th>Días Restantes</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                <!-- Data will be loaded via AJAX -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
      
    </div>
    
  </div>
  
  <!-- Payment Modal -->
  <div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="paymentModalLabel">
            <i class="bi bi-cash"></i> Registrar Pago
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          
          <!-- Client Info -->
          <div class="alert alert-info">
            <strong>Cliente:</strong> <span id="modalClientName"></span><br>
            <strong>Plan:</strong> <span id="modalPlanId"></span>
          </div>
          
          <!-- Payment Form -->
          <form id="paymentForm">
            <input type="hidden" id="modalInstallmentId">
            <input type="hidden" id="modalClientId">
            
            <div class="row g-3 mb-3">
              <div class="col-md-6">
                <label for="paymentAmount" class="form-label">Monto a Pagar (S/)</label>
                <input type="number" class="form-control" id="paymentAmount" 
                       min="0.01" step="0.01" required>
                <small class="form-text text-muted">
                  Saldo pendiente: <span id="modalPendingAmount">S/ 0.00</span>
                </small>
              </div>
              <div class="col-md-6">
                <label for="paymentMethod" class="form-label">Método de Pago</label>
                <select class="form-select" id="paymentMethod" required>
                  <option value="EFECTIVO">Efectivo</option>
                  <option value="TRANSFERENCIA">Transferencia</option>
                  <option value="YAPE">Yape</option>
                  <option value="PLIN">Plin</option>
                  <option value="TARJETA">Tarjeta</option>
                </select>
              </div>
            </div>
            
            <!-- Installments that will be paid -->
            <div class="mb-3">
              <label class="form-label">Cuotas que se pagarán con este monto:</label>
              <div id="installmentsToPay" class="border rounded p-3 bg-light">
                <!-- Will be populated dynamically -->
              </div>
            </div>
            
          </form>
          
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="bi bi-x-circle"></i> Cancelar
          </button>
          <button type="button" class="btn btn-primary" onclick="confirmPayment()">
            <i class="bi bi-check-circle"></i> Confirmar Pago
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Receipt Modal -->
  <div class="modal fade" id="receiptModal" tabindex="-1" aria-labelledby="receiptModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="receiptModalLabel">
            <i class="bi bi-receipt"></i> Recibo de Pago
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="receiptContent">
          <!-- Receipt content will be loaded here -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="bi bi-x-circle"></i> Cerrar
          </button>
          <button type="button" class="btn btn-primary" onclick="printReceipt()">
            <i class="bi bi-printer"></i> Imprimir
          </button>
          <button type="button" class="btn btn-info" onclick="emailReceipt()">
            <i class="bi bi-envelope"></i> Enviar por Email
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- DataTables JS -->
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
  
  <script>
    // CRÍTICO: Esperar a que las variables globales estén disponibles
    function waitForGlobals(callback) {
      const maxAttempts = 50; // 5 segundos máximo
      let attempts = 0;
      
      const checkInterval = setInterval(function() {
        attempts++;
        
        // Verificar si las variables globales están disponibles
        if (typeof window.SCRIPT_URL !== 'undefined' && 
            typeof window.USER_DATA !== 'undefined' && 
            typeof jQuery !== 'undefined') {
          clearInterval(checkInterval);
          console.log('✓ Variables globales disponibles para Collections');
          console.log('  - SCRIPT_URL:', window.SCRIPT_URL);
          console.log('  - USER_DATA:', window.USER_DATA);
          callback();
        } else if (attempts >= maxAttempts) {
          clearInterval(checkInterval);
          console.error('❌ Timeout esperando variables globales');
          console.error('  - window.SCRIPT_URL:', typeof window.SCRIPT_URL);
          console.error('  - window.USER_DATA:', typeof window.USER_DATA);
          console.error('  - jQuery:', typeof jQuery);
        }
      }, 100); // Verificar cada 100ms
    }
    
    let overdueTable, todayTable, weekTable;
    let currentPaymentData = null;
    let currentReceiptId = null;
    
    // Esperar a que todo esté listo
    waitForGlobals(function() {
      $(document).ready(function() {
      // Initialize DataTables
      initializeTables();
      
      // Load summary data
      loadSummary();
      
      // Update installments to pay when amount changes
      $('#paymentAmount').on('input', function() {
        updateInstallmentsToPay();
      });
    });
    }); // Cierre de waitForGlobals
    
    /**
     * Initialize DataTables
     */
    function initializeTables() {
      // CRÍTICO: Obtener parámetros de sesión para usar en los enlaces
      const sessionUser = '<?= sessionUser ?>';
      const sessionToken = '<?= sessionToken ?>';
      
      const commonColumns = [
        { 
          data: 'client_name',
          render: function(data, type, row) {
            // CRÍTICO: Incluir parámetros de sesión en el enlace
            const clientUrl = '?page=cliente-detalle&id=' + row.client_id + '&user=' + encodeURIComponent(sessionUser) + '&token=' + encodeURIComponent(sessionToken);
            return '<a href="' + clientUrl + '">' + (data || 'Cliente') + '</a>';
          }
        },
        { data: 'plan_id' },
        { data: 'installment_number' },
        { 
          data: 'amount',
          render: function(data) {
            return 'S/ ' + parseFloat(data || 0).toFixed(2);
          }
        },
        { 
          data: 'paid_amount',
          render: function(data) {
            return 'S/ ' + parseFloat(data || 0).toFixed(2);
          }
        },
        { 
          data: null,
          render: function(data, type, row) {
            const amount = parseFloat(row.amount || 0);
            const paidAmount = parseFloat(row.paid_amount || 0);
            const balance = amount - paidAmount;
            return '<strong>S/ ' + balance.toFixed(2) + '</strong>';
          }
        },
        { 
          data: 'due_date',
          render: function(data) {
            return data ? new Date(data).toLocaleDateString('es-PE') : '-';
          }
        }
      ];
      
      // Overdue Table
      overdueTable = $('#overdueTable').DataTable({
        language: {
          url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json'
        },
        pageLength: 25,
        lengthMenu: [[25, 50, 100], [25, 50, 100]],
        responsive: true,
        processing: true,
        serverSide: false,
        ajax: {
          url: window.SCRIPT_URL,
          type: 'POST',
          data: { 
            action: 'getOverdueInstallments',
            userEmail: window.USER_DATA ? window.USER_DATA.email : ''
          },
          dataSrc: function(json) {
            console.log('Respuesta overdue:', json);
            if (!json || (!json.success && !json.ok)) {
              console.error('Error loading overdue:', json ? json.error : 'No response');
              return [];
            }
            return json.data || [];
          },
          error: function(xhr, error, thrown) {
            console.error('Error AJAX overdue:', error, thrown);
            if (window.handleDataTableError) {
              window.handleDataTableError(xhr, error, thrown, 'overdueTable');
            }
          }
        },
        columns: [
          ...commonColumns,
          { 
            data: null,
            render: function(data, type, row) {
              const dueDate = new Date(row.due_date);
              const today = new Date();
              const diffTime = today - dueDate;
              const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
              return '<span class="badge bg-danger">' + diffDays + ' días</span>';
            }
          },
          {
            data: null,
            orderable: false,
            render: function(data, type, row) {
              return `
                <button type="button" class="btn btn-sm btn-success" 
                        onclick='openPaymentModal(${JSON.stringify(row)})' title="Registrar Pago">
                  <i class="bi bi-cash"></i>
                </button>
              `;
            }
          }
        ],
        order: [[7, 'asc']],
        rowCallback: function(row, data) {
          $(row).addClass('overdue-row');
        }
      });
      
      // Today Table
      todayTable = $('#todayTable').DataTable({
        language: {
          url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json'
        },
        pageLength: 25,
        lengthMenu: [[25, 50, 100], [25, 50, 100]],
        responsive: true,
        processing: true,
        serverSide: false,
        ajax: {
          url: window.SCRIPT_URL,
          type: 'POST',
          data: { 
            action: 'getTodayInstallments',
            userEmail: window.USER_DATA ? window.USER_DATA.email : ''
          },
          dataSrc: function(json) {
            console.log('Respuesta today:', json);
            if (!json || (!json.success && !json.ok)) {
              console.error('Error loading today:', json ? json.error : 'No response');
              return [];
            }
            return json.data || [];
          },
          error: function(xhr, error, thrown) {
            console.error('Error AJAX today:', error, thrown);
            if (window.handleDataTableError) {
              window.handleDataTableError(xhr, error, thrown, 'todayTable');
            }
          }
        },
        columns: [
          ...commonColumns,
          {
            data: null,
            orderable: false,
            render: function(data, type, row) {
              return `
                <button type="button" class="btn btn-sm btn-success" 
                        onclick='openPaymentModal(${JSON.stringify(row)})' title="Registrar Pago">
                  <i class="bi bi-cash"></i>
                </button>
              `;
            }
          }
        ],
        order: [[0, 'asc']],
        rowCallback: function(row, data) {
          $(row).addClass('today-row');
        }
      });
      
      // Week Table
      weekTable = $('#weekTable').DataTable({
        language: {
          url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json'
        },
        pageLength: 25,
        lengthMenu: [[25, 50, 100], [25, 50, 100]],
        responsive: true,
        processing: true,
        serverSide: false,
        ajax: {
          url: window.SCRIPT_URL,
          type: 'POST',
          data: { 
            action: 'getWeekInstallments',
            userEmail: window.USER_DATA ? window.USER_DATA.email : ''
          },
          dataSrc: function(json) {
            console.log('Respuesta week:', json);
            if (!json || (!json.success && !json.ok)) {
              console.error('Error loading week:', json ? json.error : 'No response');
              return [];
            }
            return json.data || [];
          },
          error: function(xhr, error, thrown) {
            console.error('Error AJAX week:', error, thrown);
            if (window.handleDataTableError) {
              window.handleDataTableError(xhr, error, thrown, 'weekTable');
            }
          }
        },
        columns: [
          ...commonColumns,
          { 
            data: null,
            render: function(data, type, row) {
              const dueDate = new Date(row.due_date);
              const today = new Date();
              const diffTime = dueDate - today;
              const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
              return '<span class="badge bg-info">' + diffDays + ' días</span>';
            }
          },
          {
            data: null,
            orderable: false,
            render: function(data, type, row) {
              return `
                <button type="button" class="btn btn-sm btn-success" 
                        onclick='openPaymentModal(${JSON.stringify(row)})' title="Registrar Pago">
                  <i class="bi bi-cash"></i>
                </button>
              `;
            }
          }
        ],
        order: [[7, 'asc']]
      });
    }
    
    /**
     * Load summary data
     */
    function loadSummary() {
      $.ajax({
        url: window.SCRIPT_URL,
        type: 'POST',
        data: { 
          action: 'getCollectionsSummary',
          userEmail: window.USER_DATA ? window.USER_DATA.email : ''
        },
        success: function(response) {
          console.log('Respuesta summary:', response);
          if (response && (response.success || response.ok) && response.data) {
            const summary = response.data;
            
            $('#overdueCount').text(summary.overdue.count || 0);
            $('#overdueAmount').text('S/ ' + parseFloat(summary.overdue.amount || 0).toFixed(2));
            
            $('#todayCount').text(summary.today.count || 0);
            $('#todayAmount').text('S/ ' + parseFloat(summary.today.amount || 0).toFixed(2));
            
            $('#weekCount').text(summary.week.count || 0);
            $('#weekAmount').text('S/ ' + parseFloat(summary.week.amount || 0).toFixed(2));
          }
        },
        error: function(xhr, status, error) {
          console.error('Error loading summary:', error);
        }
      });
    }
    
    /**
     * Refresh all tables
     */
    function refreshAllTables() {
      overdueTable.ajax.reload();
      todayTable.ajax.reload();
      weekTable.ajax.reload();
      loadSummary();
      showAlert('success', 'Datos actualizados');
    }
    
    /**
     * Open payment modal
     */
    function openPaymentModal(installmentData) {
      currentPaymentData = installmentData;
      
      // Populate modal
      $('#modalClientName').text(installmentData.client_name || 'Cliente');
      $('#modalPlanId').text(installmentData.plan_id || '');
      $('#modalInstallmentId').val(installmentData.id);
      $('#modalClientId').val(installmentData.client_id);
      
      const amount = parseFloat(installmentData.amount || 0);
      const paidAmount = parseFloat(installmentData.paid_amount || 0);
      const balance = amount - paidAmount;
      
      $('#modalPendingAmount').text('S/ ' + balance.toFixed(2));
      $('#paymentAmount').val(balance.toFixed(2));
      $('#paymentMethod').val('EFECTIVO');
      
      // Update installments to pay
      updateInstallmentsToPay();
      
      // Show modal
      const modal = new bootstrap.Modal(document.getElementById('paymentModal'));
      modal.show();
    }
    
    /**
     * Update installments that will be paid
     */
    function updateInstallmentsToPay() {
      const paymentAmount = parseFloat($('#paymentAmount').val() || 0);
      const clientId = $('#modalClientId').val();
      
      if (!clientId || paymentAmount <= 0) {
        $('#installmentsToPay').html('<p class="text-muted mb-0">Ingrese un monto válido</p>');
        return;
      }
      
      // Get client's pending installments
      $.ajax({
        url: window.SCRIPT_URL,
        type: 'POST',
        data: {
          action: 'getClientPendingInstallments',
          clientId: clientId,
          paymentAmount: paymentAmount
        },
        success: function(response) {
          if (response.success && response.data) {
            displayInstallmentsToPay(response.data);
          }
        },
        error: function(xhr, status, error) {
          console.error('Error loading installments:', error);
        }
      });
    }
    
    /**
     * Display installments that will be paid
     */
    function displayInstallmentsToPay(installments) {
      if (!installments || installments.length === 0) {
        $('#installmentsToPay').html('<p class="text-muted mb-0">No hay cuotas pendientes</p>');
        return;
      }
      
      let html = '<table class="table table-sm mb-0">';
      html += '<thead><tr><th>Cuota</th><th>Monto</th><th>A Pagar</th></tr></thead>';
      html += '<tbody>';
      
      for (let i = 0; i < installments.length; i++) {
        const inst = installments[i];
        html += '<tr>';
        html += '<td>Cuota ' + inst.installment_number + ' (Plan ' + inst.plan_id + ')</td>';
        html += '<td>S/ ' + parseFloat(inst.balance).toFixed(2) + '</td>';
        html += '<td><strong>S/ ' + parseFloat(inst.payment_applied).toFixed(2) + '</strong></td>';
        html += '</tr>';
      }
      
      html += '</tbody></table>';
      $('#installmentsToPay').html(html);
    }
    
    /**
     * Confirm payment
     */
    function confirmPayment() {
      const paymentAmount = parseFloat($('#paymentAmount').val() || 0);
      const paymentMethod = $('#paymentMethod').val();
      const clientId = $('#modalClientId').val();
      
      if (paymentAmount <= 0) {
        showAlert('danger', 'El monto debe ser mayor a 0');
        return;
      }
      
      if (!paymentMethod) {
        showAlert('danger', 'Seleccione un método de pago');
        return;
      }
      
      // Disable button
      const btn = event.target;
      $(btn).prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>Procesando...');
      
      // Generate requestId for idempotency
      const requestId = 'PAY_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      
      // Submit payment
      $.ajax({
        url: window.SCRIPT_URL,
        type: 'POST',
        data: {
          action: 'recordPayment',
          clientId: clientId,
          amount: paymentAmount,
          paymentMethod: paymentMethod,
          requestId: requestId
        },
        success: function(response) {
          $(btn).prop('disabled', false).html('<i class="bi bi-check-circle"></i> Confirmar Pago');
          
          if (response.success) {
            // Close payment modal
            bootstrap.Modal.getInstance(document.getElementById('paymentModal')).hide();
            
            // Show success message
            showAlert('success', 'Pago registrado exitosamente');
            
            // Refresh tables
            refreshAllTables();
            
            // Show receipt if available
            if (response.data && response.data.receiptId) {
              currentReceiptId = response.data.receiptId;
              showReceipt(response.data);
            }
          } else {
            showAlert('danger', 'Error al registrar pago: ' + (response.error || 'Error desconocido'));
          }
        },
        error: function(xhr, status, error) {
          $(btn).prop('disabled', false).html('<i class="bi bi-check-circle"></i> Confirmar Pago');
          showAlert('danger', 'Error de conexión al registrar pago: ' + error);
        }
      });
    }
    
    /**
     * Show receipt
     */
    function showReceipt(receiptData) {
      let html = '<div class="receipt-content">';
      html += '<div class="text-center mb-4">';
      html += '<h4>RECIBO DE PAGO</h4>';
      html += '<p class="mb-0">N° ' + receiptData.receiptNumber + '</p>';
      html += '</div>';
      
      html += '<div class="row mb-3">';
      html += '<div class="col-6"><strong>Fecha:</strong> ' + new Date(receiptData.date).toLocaleDateString('es-PE') + '</div>';
      html += '<div class="col-6"><strong>Hora:</strong> ' + new Date(receiptData.date).toLocaleTimeString('es-PE') + '</div>';
      html += '</div>';
      
      html += '<div class="mb-3">';
      html += '<strong>Cliente:</strong> ' + receiptData.clientName + '<br>';
      html += '<strong>DNI:</strong> ' + receiptData.clientDNI;
      html += '</div>';
      
      html += '<div class="mb-3">';
      html += '<strong>Monto Pagado:</strong> <span class="h4">S/ ' + parseFloat(receiptData.amount).toFixed(2) + '</span><br>';
      html += '<strong>Método:</strong> ' + receiptData.paymentMethod;
      html += '</div>';
      
      if (receiptData.installmentsPaid && receiptData.installmentsPaid.length > 0) {
        html += '<div class="mb-3">';
        html += '<strong>Cuotas Pagadas:</strong>';
        html += '<ul class="mb-0">';
        for (let i = 0; i < receiptData.installmentsPaid.length; i++) {
          const inst = receiptData.installmentsPaid[i];
          html += '<li>Cuota ' + inst.number + ' - S/ ' + parseFloat(inst.amount).toFixed(2) + '</li>';
        }
        html += '</ul>';
        html += '</div>';
      }
      
      html += '<div class="mb-3">';
      html += '<strong>Saldo Pendiente:</strong> S/ ' + parseFloat(receiptData.remainingBalance || 0).toFixed(2);
      html += '</div>';
      
      html += '</div>';
      
      $('#receiptContent').html(html);
      
      // Show receipt modal
      const modal = new bootstrap.Modal(document.getElementById('receiptModal'));
      modal.show();
    }
    
    /**
     * Print receipt
     */
    function printReceipt() {
      if (!currentReceiptId) {
        showAlert('warning', 'No hay recibo para imprimir');
        return;
      }
      
      // CRÍTICO: Construir URL con parámetros de sesión
      const sessionUser = '<?= sessionUser ?>';
      const sessionToken = '<?= sessionToken ?>';
      const receiptUrl = '?page=recibo&id=' + currentReceiptId + '&user=' + encodeURIComponent(sessionUser) + '&token=' + encodeURIComponent(sessionToken);
      
      window.open(receiptUrl, '_blank');
    }
    
    /**
     * Email receipt
     */
    function emailReceipt() {
      if (!currentReceiptId) {
        showAlert('warning', 'No hay recibo para enviar');
        return;
      }
      
      const email = prompt('Ingrese el email del cliente:');
      if (!email) return;
      
      $.ajax({
        url: window.SCRIPT_URL,
        type: 'POST',
        data: {
          action: 'emailReceipt',
          receiptId: currentReceiptId,
          email: email
        },
        success: function(response) {
          if (response.success) {
            showAlert('success', 'Recibo enviado por email exitosamente');
          } else {
            showAlert('danger', 'Error al enviar recibo: ' + (response.error || 'Error desconocido'));
          }
        },
        error: function(xhr, status, error) {
          showAlert('danger', 'Error de conexión al enviar recibo: ' + error);
        }
      });
    }
    
    /**
     * Show alert message
     */
    function showAlert(type, message) {
      const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      `;
      $('#alertContainer').html(alertHtml);
      
      // Auto-dismiss after 5 seconds
      setTimeout(function() {
        $('.alert').alert('close');
      }, 5000);
    }
  </script>
  
</body>
</html>

