<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    .action-buttons {
      display: flex;
      gap: 5px;
    }
    .days-badge {
      font-weight: bold;
    }
  </style>
</head>
<body>
  
  <div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h5 class="mb-0">
        <i class="bi bi-clock-history"></i> Mercadería Estancada (Más de 180 días)
      </h5>
      <div>
        <button class="btn btn-sm btn-outline-secondary" onclick="refreshTable()">
          <i class="bi bi-arrow-clockwise"></i> Actualizar
        </button>
      </div>
    </div>
    <div class="card-body">
      <div class="alert alert-info">
        <i class="bi bi-info-circle"></i> 
        Esta vista muestra productos que llevan más de 180 días en inventario sin venderse.
        Considere aplicar descuentos, transferir a otra sucursal o marcar para liquidación.
      </div>
      
      <table id="stalledInventoryTable" class="table table-striped table-hover">
        <thead>
          <tr>
            <th>ID</th>
            <th>Producto</th>
            <th>Talla</th>
            <th>Días en Inventario</th>
            <th>Fecha Ingreso</th>
            <th>Precio Compra</th>
            <th>Precio Venta</th>
            <th>Stock</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td colspan="9" class="text-center">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
  
  <!-- Modal para aplicar descuento -->
  <div class="modal fade" id="discountModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Aplicar Descuento</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="discountProductId">
          <div class="mb-3">
            <label class="form-label">Producto:</label>
            <p id="discountProductName" class="fw-bold"></p>
          </div>
          <div class="mb-3">
            <label class="form-label">Precio Actual:</label>
            <p id="discountCurrentPrice" class="fw-bold"></p>
          </div>
          <div class="mb-3">
            <label for="discountPercent" class="form-label">Porcentaje de Descuento:</label>
            <input type="number" class="form-control" id="discountPercent" min="5" max="70" value="20">
            <small class="text-muted">Entre 5% y 70%</small>
          </div>
          <div class="mb-3">
            <label class="form-label">Nuevo Precio:</label>
            <p id="discountNewPrice" class="fw-bold text-success"></p>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" onclick="applyDiscount()">Aplicar Descuento</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Modal para transferir -->
  <div class="modal fade" id="transferModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Transferir Producto</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="transferProductId">
          <div class="mb-3">
            <label class="form-label">Producto:</label>
            <p id="transferProductName" class="fw-bold"></p>
          </div>
          <div class="mb-3">
            <label for="transferDestination" class="form-label">Destino:</label>
            <select class="form-select" id="transferDestination">
              <option value="">Seleccione destino...</option>
              <option value="SUCURSAL_2">Sucursal 2</option>
              <option value="ALMACEN">Almacén Central</option>
              <option value="OUTLET">Outlet</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="transferQuantity" class="form-label">Cantidad:</label>
            <input type="number" class="form-control" id="transferQuantity" min="1" value="1">
          </div>
          <div class="mb-3">
            <label for="transferNotes" class="form-label">Notas:</label>
            <textarea class="form-control" id="transferNotes" rows="2"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" onclick="transferProduct()">Transferir</button>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    let stalledInventoryTable;
    let currentProducts = [];
    
    $(document).ready(function() {
      console.log('StalledInventory.html cargado');
      
      // Inicializar DataTable
      stalledInventoryTable = $('#stalledInventoryTable').DataTable({
        language: {
          url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json'
        },
        pageLength: 25,
        order: [[3, 'desc']], // Ordenar por días en inventario (descendente)
        columnDefs: [
          { targets: 8, orderable: false } // Columna de acciones no ordenable
        ],
        // Agregar manejo de errores
        error: function(xhr, error, thrown) {
          console.error('Error en DataTable:', error);
          if (window.handleDataTableError) {
            window.handleDataTableError(xhr, error, thrown, 'stalledInventoryTable');
          }
        }
      });
      
      // Cargar datos
      loadStalledInventory();
      
      // Calcular nuevo precio cuando cambia el porcentaje de descuento
      $('#discountPercent').on('input', function() {
        calculateNewPrice();
      });
    });
    
    function loadStalledInventory() {
      console.log('Cargando mercadería estancada...');
      
      $.ajax({
        url: window.SCRIPT_URL,
        type: 'POST',
        data: {
          action: 'getStalledInventory',
          userEmail: window.USER_DATA.email
        },
        success: function(response) {
          console.log('Respuesta recibida:', response);
          
          if (response.success || response.ok) {
            currentProducts = response.data || [];
            displayStalledInventory(currentProducts);
          } else {
            showError('Error al cargar datos: ' + (response.error || 'Error desconocido'));
          }
        },
        error: function(xhr, status, error) {
          console.error('Error AJAX:', error);
          showError('Error de conexión: ' + error);
        }
      });
    }
    
    function displayStalledInventory(products) {
      stalledInventoryTable.clear();
      
      if (products.length === 0) {
        stalledInventoryTable.row.add([
          '', '', '', '', '', '', '', '',
          '<td colspan="9" class="text-center text-success"><i class="bi bi-check-circle"></i> No hay mercadería estancada</td>'
        ]).draw();
        return;
      }
      
      products.forEach(function(product) {
        const daysInInventory = calculateDaysInInventory(product.entry_date);
        const badgeClass = daysInInventory > 365 ? 'bg-danger' : daysInInventory > 270 ? 'bg-warning' : 'bg-info';
        
        stalledInventoryTable.row.add([
          product.id,
          product.name || 'Sin nombre',
          product.size || '-',
          '<span class="badge ' + badgeClass + ' days-badge">' + daysInInventory + ' días</span>',
          formatDate(product.entry_date),
          'S/ ' + parseFloat(product.purchase_price || 0).toFixed(2),
          'S/ ' + parseFloat(product.sale_price || 0).toFixed(2),
          product.stock || 0,
          '<div class="action-buttons">' +
            '<button class="btn btn-sm btn-warning" onclick="openDiscountModal(\'' + product.id + '\')" title="Aplicar descuento">' +
              '<i class="bi bi-percent"></i>' +
            '</button>' +
            '<button class="btn btn-sm btn-info" onclick="openTransferModal(\'' + product.id + '\')" title="Transferir">' +
              '<i class="bi bi-arrow-left-right"></i>' +
            '</button>' +
            '<button class="btn btn-sm btn-danger" onclick="markForLiquidation(\'' + product.id + '\')" title="Marcar para liquidación">' +
              '<i class="bi bi-tag"></i>' +
            '</button>' +
          '</div>'
        ]).draw(false);
      });
    }
    
    function calculateDaysInInventory(entryDate) {
      if (!entryDate) return 0;
      
      const entry = new Date(entryDate);
      const today = new Date();
      const diffTime = Math.abs(today - entry);
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
      
      return diffDays;
    }
    
    function formatDate(dateStr) {
      if (!dateStr) return '-';
      const date = new Date(dateStr);
      return date.toLocaleDateString('es-PE');
    }
    
    function refreshTable() {
      loadStalledInventory();
    }
    
    function openDiscountModal(productId) {
      const product = currentProducts.find(p => p.id === productId);
      if (!product) return;
      
      $('#discountProductId').val(productId);
      $('#discountProductName').text(product.name + ' - ' + (product.size || 'Sin talla'));
      $('#discountCurrentPrice').text('S/ ' + parseFloat(product.sale_price || 0).toFixed(2));
      $('#discountPercent').val(20);
      
      calculateNewPrice();
      
      const modal = new bootstrap.Modal(document.getElementById('discountModal'));
      modal.show();
    }
    
    function calculateNewPrice() {
      const productId = $('#discountProductId').val();
      const product = currentProducts.find(p => p.id === productId);
      if (!product) return;
      
      const currentPrice = parseFloat(product.sale_price || 0);
      const discountPercent = parseFloat($('#discountPercent').val() || 0);
      const newPrice = currentPrice * (1 - discountPercent / 100);
      
      $('#discountNewPrice').text('S/ ' + newPrice.toFixed(2));
    }
    
    function applyDiscount() {
      const productId = $('#discountProductId').val();
      const discountPercent = parseFloat($('#discountPercent').val());
      
      if (!productId || !discountPercent || discountPercent < 5 || discountPercent > 70) {
        alert('Por favor ingrese un porcentaje válido entre 5% y 70%');
        return;
      }
      
      const product = currentProducts.find(p => p.id === productId);
      if (!product) return;
      
      const currentPrice = parseFloat(product.sale_price || 0);
      const newPrice = currentPrice * (1 - discountPercent / 100);
      
      if (!confirm('¿Aplicar descuento del ' + discountPercent + '% a ' + product.name + '?\nPrecio actual: S/ ' + currentPrice.toFixed(2) + '\nNuevo precio: S/ ' + newPrice.toFixed(2))) {
        return;
      }
      
      $.ajax({
        url: window.SCRIPT_URL,
        type: 'POST',
        data: {
          action: 'applyStalledDiscount',
          userEmail: window.USER_DATA.email,
          productId: productId,
          discountPercent: discountPercent,
          newPrice: newPrice
        },
        success: function(response) {
          if (response.success || response.ok) {
            alert('Descuento aplicado exitosamente');
            bootstrap.Modal.getInstance(document.getElementById('discountModal')).hide();
            refreshTable();
          } else {
            alert('Error: ' + (response.error || 'Error desconocido'));
          }
        },
        error: function(xhr, status, error) {
          alert('Error de conexión: ' + error);
        }
      });
    }
    
    function openTransferModal(productId) {
      const product = currentProducts.find(p => p.id === productId);
      if (!product) return;
      
      $('#transferProductId').val(productId);
      $('#transferProductName').text(product.name + ' - ' + (product.size || 'Sin talla'));
      $('#transferQuantity').val(1).attr('max', product.stock || 1);
      $('#transferDestination').val('');
      $('#transferNotes').val('');
      
      const modal = new bootstrap.Modal(document.getElementById('transferModal'));
      modal.show();
    }
    
    function transferProduct() {
      const productId = $('#transferProductId').val();
      const destination = $('#transferDestination').val();
      const quantity = parseInt($('#transferQuantity').val());
      const notes = $('#transferNotes').val();
      
      if (!destination) {
        alert('Por favor seleccione un destino');
        return;
      }
      
      if (!quantity || quantity < 1) {
        alert('Por favor ingrese una cantidad válida');
        return;
      }
      
      const product = currentProducts.find(p => p.id === productId);
      if (!product) return;
      
      if (!confirm('¿Transferir ' + quantity + ' unidad(es) de ' + product.name + ' a ' + destination + '?')) {
        return;
      }
      
      $.ajax({
        url: window.SCRIPT_URL,
        type: 'POST',
        data: {
          action: 'transferStalledProduct',
          userEmail: window.USER_DATA.email,
          productId: productId,
          destination: destination,
          quantity: quantity,
          notes: notes
        },
        success: function(response) {
          if (response.success || response.ok) {
            alert('Transferencia registrada exitosamente');
            bootstrap.Modal.getInstance(document.getElementById('transferModal')).hide();
            refreshTable();
          } else {
            alert('Error: ' + (response.error || 'Error desconocido'));
          }
        },
        error: function(xhr, status, error) {
          alert('Error de conexión: ' + error);
        }
      });
    }
    
    function markForLiquidation(productId) {
      const product = currentProducts.find(p => p.id === productId);
      if (!product) return;
      
      if (!confirm('¿Marcar ' + product.name + ' para liquidación?\nEsto agregará una etiqueta especial al producto.')) {
        return;
      }
      
      $.ajax({
        url: window.SCRIPT_URL,
        type: 'POST',
        data: {
          action: 'markForLiquidation',
          userEmail: window.USER_DATA.email,
          productId: productId
        },
        success: function(response) {
          if (response.success || response.ok) {
            alert('Producto marcado para liquidación');
            refreshTable();
          } else {
            alert('Error: ' + (response.error || 'Error desconocido'));
          }
        },
        error: function(xhr, status, error) {
          alert('Error de conexión: ' + error);
        }
      });
    }
    
    function showError(message) {
      stalledInventoryTable.clear();
      stalledInventoryTable.row.add([
        '', '', '', '', '', '', '', '',
        '<td colspan="9" class="text-center text-danger"><i class="bi bi-exclamation-triangle"></i> ' + message + '</td>'
      ]).draw();
    }
  </script>
  
</body>
</html>
