<!DOCTYPE html>
<html lang="es-PE">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Transferencia entre Almacenes - Adiction Boutique</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.min.css">
</head>
<body>
  <div class="container py-4">
    <h2><i class="bi bi-arrow-left-right"></i> Transferencia entre Almacenes</h2>
    
    <div id="alertContainer"></div>
    
    <div class="card">
      <div class="card-body">
        <form id="transferForm">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="fromWarehouse" class="form-label">Almacén Origen <span class="text-danger">*</span></label>
              <select id="fromWarehouse" class="form-select" required>
                <option value="">Seleccione...</option>
                <option value="warehouse-mujeres">Almacén Mujeres</option>
                <option value="warehouse-hombres">Almacén Hombres</option>
              </select>
            </div>
            
            <div class="col-md-6 mb-3">
              <label for="toWarehouse" class="form-label">Almacén Destino <span class="text-danger">*</span></label>
              <select id="toWarehouse" class="form-select" required>
                <option value="">Seleccione...</option>
                <option value="warehouse-mujeres">Almacén Mujeres</option>
                <option value="warehouse-hombres">Almacén Hombres</option>
              </select>
            </div>
            
            <div class="col-md-8 mb-3">
              <label for="productSearch" class="form-label">Producto <span class="text-danger">*</span></label>
              <input type="text" id="productSearch" class="form-control" placeholder="Buscar por nombre o código de barras" required>
              <input type="hidden" id="productId">
              <div id="productResults" class="list-group mt-2" style="display:none;"></div>
            </div>
            
            <div class="col-md-4 mb-3">
              <label for="quantity" class="form-label">Cantidad <span class="text-danger">*</span></label>
              <input type="number" id="quantity" class="form-control" min="1" required>
              <small class="text-muted">Stock disponible: <span id="availableStock">-</span></small>
            </div>
            
            <div class="col-md-12 mb-3">
              <div class="alert alert-info">
                <i class="bi bi-info-circle"></i> La transferencia se registrará con un ID único para garantizar atomicidad e idempotencia.
              </div>
            </div>
          </div>
          
          <div class="d-flex justify-content-end gap-2">
            <button type="button" class="btn btn-secondary" onclick="window.location.href='?page=inventario'">
              Cancelar
            </button>
            <button type="submit" class="btn btn-primary" id="submitBtn">
              <i class="bi bi-arrow-left-right"></i> Ejecutar Transferencia
            </button>
          </div>
        </form>
      </div>
    </div>
    
    <div id="resultCard" class="card mt-4" style="display:none;">
      <div class="card-header bg-success text-white">
        <h5 class="mb-0"><i class="bi bi-check-circle"></i> Transferencia Exitosa</h5>
      </div>
      <div class="card-body">
        <dl class="row">
          <dt class="col-sm-3">Transfer ID:</dt>
          <dd class="col-sm-9" id="resultTransferId"></dd>
          
          <dt class="col-sm-3">Producto:</dt>
          <dd class="col-sm-9" id="resultProduct"></dd>
          
          <dt class="col-sm-3">Cantidad:</dt>
          <dd class="col-sm-9" id="resultQuantity"></dd>
          
          <dt class="col-sm-3">Origen → Destino:</dt>
          <dd class="col-sm-9" id="resultRoute"></dd>
        </dl>
        <button class="btn btn-primary" onclick="location.reload()">
          Nueva Transferencia
        </button>
      </div>
    </div>
  </div>
  
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    let selectedProduct = null;
    
    $(document).ready(function() {
      // Product search
      $('#productSearch').on('input', function() {
        const query = $(this).val().trim();
        if (query.length >= 2) {
          searchProducts(query);
        } else {
          $('#productResults').hide();
        }
      });
      
      // Warehouse change - check stock
      $('#fromWarehouse, #productId').on('change', function() {
        checkAvailableStock();
      });
      
      // Form submission
      $('#transferForm').on('submit', function(e) {
        e.preventDefault();
        executeTransfer();
      });
    });
    
    function searchProducts(query) {
      $.ajax({
        url: '<?= scriptUrl ?>',
        type: 'POST',
        data: {
          action: 'searchProducts',
          payload: JSON.stringify({ query: query })
        },
        success: function(response) {
          if (response.success && response.data.length > 0) {
            displayProductResults(response.data);
          } else {
            $('#productResults').hide();
          }
        }
      });
    }
    
    function displayProductResults(products) {
      const html = products.map(p => 
        `<a href="#" class="list-group-item list-group-item-action" onclick="selectProduct('${p.id}', '${p.name}', '${p.barcode}'); return false;">
          <strong>${p.name}</strong><br>
          <small>Código: ${p.barcode} | Categoría: ${p.category}</small>
        </a>`
      ).join('');
      
      $('#productResults').html(html).show();
    }
    
    function selectProduct(id, name, barcode) {
      selectedProduct = { id, name, barcode };
      $('#productId').val(id);
      $('#productSearch').val(name + ' (' + barcode + ')');
      $('#productResults').hide();
      checkAvailableStock();
    }
    
    function checkAvailableStock() {
      const warehouseId = $('#fromWarehouse').val();
      const productId = $('#productId').val();
      
      if (!warehouseId || !productId) {
        $('#availableStock').text('-');
        return;
      }
      
      $.ajax({
        url: '<?= scriptUrl ?>',
        type: 'POST',
        data: {
          action: 'checkStock',
          payload: JSON.stringify({
            warehouseId: warehouseId,
            productId: productId
          })
        },
        success: function(response) {
          if (response.success) {
            $('#availableStock').text(response.data + ' unidades');
          }
        }
      });
    }
    
    function executeTransfer() {
      const data = {
        fromWarehouse: $('#fromWarehouse').val(),
        toWarehouse: $('#toWarehouse').val(),
        productId: $('#productId').val(),
        quantity: parseInt($('#quantity').val()),
        requestId: 'transfer-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9)
      };
      
      // Validations
      if (!data.fromWarehouse || !data.toWarehouse || !data.productId || !data.quantity) {
        showAlert('warning', 'Complete todos los campos requeridos');
        return;
      }
      
      if (data.fromWarehouse === data.toWarehouse) {
        showAlert('warning', 'El almacén origen y destino no pueden ser el mismo');
        return;
      }
      
      $('#submitBtn').prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> Procesando...');
      
      $.ajax({
        url: '<?= scriptUrl ?>',
        type: 'POST',
        data: {
          action: 'transferStock',
          payload: JSON.stringify(data)
        },
        success: function(response) {
          $('#submitBtn').prop('disabled', false).html('<i class="bi bi-arrow-left-right"></i> Ejecutar Transferencia');
          
          if (response.success) {
            showTransferResult(response.data);
            $('#transferForm')[0].reset();
            selectedProduct = null;
          } else {
            showAlert('danger', 'Error: ' + response.error);
          }
        },
        error: function() {
          $('#submitBtn').prop('disabled', false).html('<i class="bi bi-arrow-left-right"></i> Ejecutar Transferencia');
          showAlert('danger', 'Error de conexión');
        }
      });
    }
    
    function showTransferResult(result) {
      $('#resultTransferId').text(result.transferId);
      $('#resultProduct').text(selectedProduct.name);
      $('#resultQuantity').text(result.quantity + ' unidades');
      $('#resultRoute').text(result.fromWarehouse + ' → ' + result.toWarehouse);
      $('#resultCard').show();
      $('html, body').animate({ scrollTop: $('#resultCard').offset().top }, 500);
    }
    
    function showAlert(type, message) {
      const html = `<div class="alert alert-${type} alert-dismissible fade show">
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>`;
      $('#alertContainer').html(html);
    }
  </script>
</body>
</html>
