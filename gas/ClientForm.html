<!DOCTYPE html>
<!--
  ClientForm.html - Formulario CRUD de Clientes
  Adiction Boutique Suite
  
  Permite crear y editar clientes con validación.
  Requisitos: 35.1
-->
<html lang="es-PE">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cliente - Adiction Boutique</title>
  
  <!-- Bootstrap 5.3 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.min.css">
</head>
<body>
  
  <div class="container py-4">
    
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2><i class="bi bi-person-badge"></i> <span id="formTitle">Nuevo Cliente</span></h2>
      <button type="button" class="btn btn-outline-secondary" onclick="window.location.href='?page=clientes'">
        <i class="bi bi-arrow-left"></i> Volver al Listado
      </button>
    </div>
    
    <!-- Alert Container -->
    <div id="alertContainer"></div>
    
    <!-- Client Form Card -->
    <div class="card">
      <div class="card-body">
        <form id="clientForm">
          
          <input type="hidden" id="clientId" name="id">
          
          <div class="row">
            
            <!-- DNI -->
            <div class="col-md-6 mb-3">
              <label for="dni" class="form-label">DNI <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="dni" name="dni" maxlength="8" required>
              <div class="invalid-feedback">
                El DNI es requerido y debe ser único.
              </div>
            </div>
            
            <!-- Nombre -->
            <div class="col-md-6 mb-3">
              <label for="name" class="form-label">Nombre Completo <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="name" name="name" required>
              <div class="invalid-feedback">
                El nombre es requerido.
              </div>
            </div>
            
            <!-- Teléfono -->
            <div class="col-md-6 mb-3">
              <label for="phone" class="form-label">Teléfono <span class="text-danger">*</span></label>
              <input type="tel" class="form-control" id="phone" name="phone" required>
              <div class="invalid-feedback">
                El teléfono es requerido.
              </div>
            </div>
            
            <!-- Email -->
            <div class="col-md-6 mb-3">
              <label for="email" class="form-label">Email</label>
              <input type="email" class="form-control" id="email" name="email">
            </div>
            
            <!-- Fecha de Cumpleaños -->
            <div class="col-md-6 mb-3">
              <label for="birthday" class="form-label">Fecha de Cumpleaños</label>
              <input type="date" class="form-control" id="birthday" name="birthday">
              <small class="form-text text-muted">
                <i class="bi bi-gift"></i> Para aplicar descuentos y obsequios especiales
              </small>
            </div>
            
            <!-- Dirección -->
            <div class="col-md-12 mb-3">
              <label for="address" class="form-label">Dirección</label>
              <textarea class="form-control" id="address" name="address" rows="2"></textarea>
            </div>
            
            <!-- Límite de Crédito -->
            <div class="col-md-6 mb-3">
              <label for="credit_limit" class="form-label">Límite de Crédito (S/)</label>
              <input type="number" class="form-control" id="credit_limit" name="credit_limit" step="0.01" min="0" value="0">
              <small class="form-text text-muted">Dejar en 0 si no se otorga crédito</small>
            </div>
            
            <!-- Estado -->
            <div class="col-md-12 mb-3">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="active" name="active" checked>
                <label class="form-check-label" for="active">
                  Cliente Activo
                </label>
              </div>
            </div>
            
          </div>
          
          <!-- Form Actions -->
          <div class="d-flex justify-content-end gap-2">
            <button type="button" class="btn btn-secondary" onclick="window.location.href='?page=clientes'">
              <i class="bi bi-x-circle"></i> Cancelar
            </button>
            <button type="submit" class="btn btn-primary" id="submitBtn">
              <i class="bi bi-save"></i> Guardar Cliente
            </button>
          </div>
          
        </form>
      </div>
    </div>
    
  </div>
  
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    let isEditMode = false;
    
    $(document).ready(function() {
      // Check if we're in edit mode
      const urlParams = new URLSearchParams(window.location.search);
      const clientId = urlParams.get('id');
      
      if (clientId) {
        isEditMode = true;
        $('#formTitle').text('Editar Cliente');
        loadClient(clientId);
      }
      
      // Form submission
      $('#clientForm').on('submit', function(e) {
        e.preventDefault();
        
        if (!this.checkValidity()) {
          e.stopPropagation();
          $(this).addClass('was-validated');
          return;
        }
        
        saveClient();
      });
    });
    
    function loadClient(clientId) {
      showLoading();
      
      google.script.run
        .withSuccessHandler(function(response) {
          hideLoading();
          
          if (response.success) {
            const client = response.data;
            
            // Fill form fields
            $('#clientId').val(client.id);
            $('#dni').val(client.dni);
            $('#name').val(client.name);
            $('#phone').val(client.phone || '');
            $('#email').val(client.email || '');
            $('#address').val(client.address || '');
            $('#credit_limit').val(client.credit_limit || 0);
            $('#active').prop('checked', client.active === true || client.active === 'true');
            
            // Handle birthday field - convert from ISO string or Date to YYYY-MM-DD format
            if (client.birthday) {
              const birthdayDate = new Date(client.birthday);
              if (!isNaN(birthdayDate.getTime())) {
                const year = birthdayDate.getFullYear();
                const month = String(birthdayDate.getMonth() + 1).padStart(2, '0');
                const day = String(birthdayDate.getDate()).padStart(2, '0');
                $('#birthday').val(`${year}-${month}-${day}`);
              }
            }
          } else {
            showAlert('danger', 'Error al cargar cliente: ' + response.error);
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          showAlert('danger', 'Error de conexión al cargar el cliente: ' + error.message);
        })
        .getClientById(clientId);
    }
    
    function saveClient() {
      const formData = {
        id: $('#clientId').val() || undefined,
        dni: $('#dni').val().trim(),
        name: $('#name').val().trim(),
        phone: $('#phone').val().trim(),
        email: $('#email').val().trim(),
        address: $('#address').val().trim(),
        credit_limit: parseFloat($('#credit_limit').val()) || 0,
        active: $('#active').is(':checked')
      };
      
      // Add birthday if provided
      const birthdayValue = $('#birthday').val();
      if (birthdayValue) {
        formData.birthday = birthdayValue; // Send as YYYY-MM-DD string
      }
      
      // Validate
      if (!formData.dni || !formData.name || !formData.phone) {
        showAlert('warning', 'Por favor complete todos los campos requeridos');
        return;
      }
      
      showLoading();
      $('#submitBtn').prop('disabled', true);
      
      const action = isEditMode ? 'updateClient' : 'createClient';
      
      google.script.run
        .withSuccessHandler(function(response) {
          hideLoading();
          $('#submitBtn').prop('disabled', false);
          
          if (response.success) {
            showAlert('success', 'Cliente guardado exitosamente');
            
            // Redirect after 2 seconds
            setTimeout(function() {
              window.location.href = '?page=clientes';
            }, 2000);
          } else {
            showAlert('danger', 'Error al guardar: ' + response.error);
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          $('#submitBtn').prop('disabled', false);
          showAlert('danger', 'Error de conexión al guardar el cliente: ' + error.message);
        })[action](formData);
    }
    
    function showAlert(type, message) {
      const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      `;
      $('#alertContainer').html(alertHtml);
      
      // Auto-dismiss after 5 seconds
      setTimeout(function() {
        $('.alert').alert('close');
      }, 5000);
    }
    
    function showLoading() {
      $('#submitBtn').html('<span class="spinner-border spinner-border-sm me-2"></span>Guardando...');
    }
    
    function hideLoading() {
      $('#submitBtn').html('<i class="bi bi-save"></i> Guardar Cliente');
    }
  </script>
  
</body>
</html>
