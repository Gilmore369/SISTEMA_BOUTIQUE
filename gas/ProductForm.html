<!DOCTYPE html>
<!--
  ProductForm.html - Formulario CRUD de Productos
  Adiction Boutique Suite
  
  Permite crear y editar productos con validación.
  Requisitos: 3.1, 3.2, 3.4
-->
<html lang="es-PE">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Producto - Adiction Boutique</title>
  
  <!-- Bootstrap 5.3 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.min.css">
</head>
<body>
  
  <div class="container py-4">
    
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2><i class="bi bi-box-seam"></i> <span id="formTitle">Nuevo Producto</span></h2>
      <button type="button" class="btn btn-outline-secondary" onclick="window.location.href='?page=productos'">
        <i class="bi bi-arrow-left"></i> Volver al Listado
      </button>
    </div>
    
    <!-- Alert Container -->
    <div id="alertContainer"></div>
    
    <!-- Product Form Card -->
    <div class="card">
      <div class="card-body">
        <form id="productForm">
          
          <input type="hidden" id="productId" name="id">
          
          <div class="row">
            
            <!-- Código de Barras -->
            <div class="col-md-6 mb-3">
              <label for="barcode" class="form-label">Código de Barras <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="barcode" name="barcode" required>
              <div class="invalid-feedback">
                El código de barras es requerido y debe ser único.
              </div>
            </div>
            
            <!-- Nombre -->
            <div class="col-md-6 mb-3">
              <label for="name" class="form-label">Nombre del Producto <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="name" name="name" required>
              <div class="invalid-feedback">
                El nombre es requerido.
              </div>
            </div>
            
            <!-- Descripción -->
            <div class="col-md-12 mb-3">
              <label for="description" class="form-label">Descripción</label>
              <textarea class="form-control" id="description" name="description" rows="3"></textarea>
            </div>
            
            <!-- Categoría -->
            <div class="col-md-4 mb-3">
              <label for="category" class="form-label">Categoría <span class="text-danger">*</span></label>
              <select class="form-select" id="category" name="category" required>
                <option value="">Seleccione...</option>
                <option value="Vestidos">Vestidos</option>
                <option value="Blusas">Blusas</option>
                <option value="Pantalones">Pantalones</option>
                <option value="Faldas">Faldas</option>
                <option value="Accesorios">Accesorios</option>
                <option value="Zapatos">Zapatos</option>
                <option value="Otros">Otros</option>
              </select>
              <div class="invalid-feedback">
                La categoría es requerida.
              </div>
            </div>
            
            <!-- Precio -->
            <div class="col-md-4 mb-3">
              <label for="price" class="form-label">Precio (S/) <span class="text-danger">*</span></label>
              <input type="number" class="form-control" id="price" name="price" step="0.01" min="0" required>
              <div class="invalid-feedback">
                El precio es requerido y debe ser mayor a 0.
              </div>
            </div>
            
            <!-- Stock Mínimo -->
            <div class="col-md-4 mb-3">
              <label for="min_stock" class="form-label">Stock Mínimo <span class="text-danger">*</span></label>
              <input type="number" class="form-control" id="min_stock" name="min_stock" min="0" value="5" required>
              <div class="invalid-feedback">
                El stock mínimo es requerido.
              </div>
            </div>
            
            <!-- Estado -->
            <div class="col-md-12 mb-3">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="active" name="active" checked>
                <label class="form-check-label" for="active">
                  Producto Activo
                </label>
              </div>
            </div>
            
          </div>
          
          <!-- Form Actions -->
          <div class="d-flex justify-content-end gap-2">
            <button type="button" class="btn btn-secondary" onclick="window.location.href='?page=productos'">
              <i class="bi bi-x-circle"></i> Cancelar
            </button>
            <button type="submit" class="btn btn-primary" id="submitBtn">
              <i class="bi bi-save"></i> Guardar Producto
            </button>
          </div>
          
        </form>
      </div>
    </div>
    
  </div>
  
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    let isEditMode = false;
    let originalPrice = null;
    
    $(document).ready(function() {
      // Check if we're in edit mode
      const urlParams = new URLSearchParams(window.location.search);
      const productId = urlParams.get('id');
      
      if (productId) {
        isEditMode = true;
        $('#formTitle').text('Editar Producto');
        loadProduct(productId);
      }
      
      // Form submission
      $('#productForm').on('submit', function(e) {
        e.preventDefault();
        
        if (!this.checkValidity()) {
          e.stopPropagation();
          $(this).addClass('was-validated');
          return;
        }
        
        saveProduct();
      });
    });
    
    function loadProduct(productId) {
      showLoading();
      
      $.ajax({
        url: '<?= scriptUrl ?>',
        type: 'POST',
        data: {
          action: 'getProduct',
          payload: JSON.stringify({ id: productId })
        },
        success: function(response) {
          hideLoading();
          
          if (response.success) {
            const product = response.data;
            
            // Fill form fields
            $('#productId').val(product.id);
            $('#barcode').val(product.barcode);
            $('#name').val(product.name);
            $('#description').val(product.description || '');
            $('#category').val(product.category);
            $('#price').val(product.price);
            $('#min_stock').val(product.min_stock || 0);
            $('#active').prop('checked', product.active === true || product.active === 'true');
            
            // Store original price for audit
            originalPrice = product.price;
          } else {
            showAlert('danger', 'Error al cargar producto: ' + response.error);
          }
        },
        error: function() {
          hideLoading();
          showAlert('danger', 'Error de conexión al cargar el producto');
        }
      });
    }
    
    function saveProduct() {
      const formData = {
        id: $('#productId').val() || undefined,
        barcode: $('#barcode').val().trim(),
        name: $('#name').val().trim(),
        description: $('#description').val().trim(),
        category: $('#category').val(),
        price: parseFloat($('#price').val()),
        min_stock: parseInt($('#min_stock').val()),
        active: $('#active').is(':checked')
      };
      
      // Validate
      if (!formData.barcode || !formData.name || !formData.category) {
        showAlert('warning', 'Por favor complete todos los campos requeridos');
        return;
      }
      
      if (formData.price <= 0) {
        showAlert('warning', 'El precio debe ser mayor a 0');
        return;
      }
      
      const action = isEditMode ? 'updateProduct' : 'createProduct';
      
      showLoading();
      $('#submitBtn').prop('disabled', true);
      
      $.ajax({
        url: '<?= scriptUrl ?>',
        type: 'POST',
        data: {
          action: action,
          payload: JSON.stringify(formData)
        },
        success: function(response) {
          hideLoading();
          $('#submitBtn').prop('disabled', false);
          
          if (response.success) {
            showAlert('success', 'Producto guardado exitosamente');
            
            // Show price change warning if applicable
            if (isEditMode && originalPrice !== formData.price) {
              showAlert('info', 'El cambio de precio ha sido registrado en auditoría');
            }
            
            // Redirect after 2 seconds
            setTimeout(function() {
              window.location.href = '?page=productos';
            }, 2000);
          } else {
            showAlert('danger', 'Error al guardar: ' + response.error);
          }
        },
        error: function() {
          hideLoading();
          $('#submitBtn').prop('disabled', false);
          showAlert('danger', 'Error de conexión al guardar el producto');
        }
      });
    }
    
    function showAlert(type, message) {
      const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      `;
      $('#alertContainer').html(alertHtml);
      
      // Auto-dismiss after 5 seconds
      setTimeout(function() {
        $('.alert').alert('close');
      }, 5000);
    }
    
    function showLoading() {
      $('#submitBtn').html('<span class="spinner-border spinner-border-sm me-2"></span>Guardando...');
    }
    
    function hideLoading() {
      $('#submitBtn').html('<i class="bi bi-save"></i> Guardar Producto');
    }
  </script>
  
</body>
</html>
