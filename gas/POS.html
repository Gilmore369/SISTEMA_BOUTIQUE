<!DOCTYPE html>
<!--
  POS.html - Vista de Punto de Venta
  Adiction Boutique Suite
  
  Interfaz de punto de venta para registrar ventas al contado.
  Requisitos: 6.1, 6.3, 21.2
-->
<html lang="es-PE">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Punto de Venta - Adiction Boutique</title>
  
  <!-- Bootstrap 5.3 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.min.css">
  
  <style>
    .product-search {
      font-size: 1.2rem;
    }
    .cart-item {
      border-bottom: 1px solid #dee2e6;
      padding: 10px 0;
    }
    .cart-item:last-child {
      border-bottom: none;
    }
    .total-panel {
      background-color: #f8f9fa;
      border-radius: 8px;
      padding: 20px;
    }
    .total-amount {
      font-size: 2rem;
      font-weight: bold;
      color: #198754;
    }
    .btn-scan {
      height: 56px;
    }
    @media (max-width: 768px) {
      .total-amount {
        font-size: 1.5rem;
      }
    }
  </style>
</head>
<body>
  
  <div class="container-fluid py-4">
    
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2><i class="bi bi-cart"></i> Punto de Venta</h2>
      <div>
        <span class="badge bg-info me-2">Tienda: <span id="storeName">-</span></span>
        <span class="badge bg-secondary">Vendedor: <span id="userName">-</span></span>
      </div>
    </div>
    
    <!-- Birthday Alert Container -->
    <div id="birthdayAlert" style="display: none;"></div>
    
    <div class="row">
      
      <!-- Left Column: Product Search & Cart -->
      <div class="col-lg-8">
        
        <!-- Product Search Card -->
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-search"></i> Buscar Producto</h5>
          </div>
          <div class="card-body">
            <div class="row g-2">
              <div class="col-md-8">
                <input type="text" 
                       id="productSearch" 
                       class="form-control product-search" 
                       placeholder="Escanear código de barras o buscar por nombre...">
              </div>
              <div class="col-md-2">
                <button type="button" class="btn btn-primary w-100 btn-scan" onclick="searchProduct()">
                  <i class="bi bi-search"></i> Buscar
                </button>
              </div>
              <div class="col-md-2">
                <button type="button" class="btn btn-outline-secondary w-100 btn-scan" onclick="openScanner()">
                  <i class="bi bi-upc-scan"></i> Escanear
                </button>
              </div>
            </div>
            
            <!-- Product Search Results -->
            <div id="searchResults" class="mt-3" style="display: none;">
              <div class="list-group" id="searchResultsList">
                <!-- Results will be populated here -->
              </div>
            </div>
          </div>
        </div>
        
        <!-- Shopping Cart Card -->
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-cart3"></i> Carrito de Compras</h5>
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="clearCart()">
              <i class="bi bi-trash"></i> Vaciar
            </button>
          </div>
          <div class="card-body">
            <div id="cartItems">
              <div class="text-center text-muted py-5">
                <i class="bi bi-cart-x" style="font-size: 3rem;"></i>
                <p class="mt-2">El carrito está vacío</p>
                <p class="small">Escanea o busca productos para agregar</p>
              </div>
            </div>
          </div>
        </div>
        
      </div>
      
      <!-- Right Column: Sale Summary & Actions -->
      <div class="col-lg-4">
        
        <!-- Sale Type Card -->
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-cash-coin"></i> Tipo de Venta</h5>
          </div>
          <div class="card-body">
            <div class="btn-group w-100" role="group">
              <input type="radio" class="btn-check" name="saleType" id="saleTypeContado" value="CONTADO" checked>
              <label class="btn btn-outline-success" for="saleTypeContado">
                <i class="bi bi-cash"></i> Contado
              </label>
              
              <input type="radio" class="btn-check" name="saleType" id="saleTypeCredito" value="CREDITO">
              <label class="btn btn-outline-warning" for="saleTypeCredito">
                <i class="bi bi-credit-card"></i> Crédito
              </label>
            </div>
            
            <!-- Client Selection (shown only for credit sales) -->
            <div id="clientSelection" class="mt-3" style="display: none;">
              <label for="clientSelect" class="form-label">Cliente</label>
              <select id="clientSelect" class="form-select">
                <option value="">Seleccionar cliente...</option>
              </select>
              <button type="button" class="btn btn-sm btn-link" onclick="openNewClient()">
                <i class="bi bi-plus-circle"></i> Nuevo Cliente
              </button>
            </div>
            
            <!-- Installments Selection (shown only for credit sales) -->
            <div id="installmentsSelection" class="mt-3" style="display: none;">
              <label for="installmentsSelect" class="form-label">Cuotas</label>
              <select id="installmentsSelect" class="form-select">
                <option value="1">1 cuota (sin interés)</option>
                <option value="2">2 cuotas (sin interés)</option>
                <option value="3">3 cuotas (sin interés)</option>
                <option value="4">4 cuotas (sin interés)</option>
                <option value="5">5 cuotas (sin interés)</option>
                <option value="6">6 cuotas (sin interés)</option>
              </select>
            </div>
          </div>
        </div>
        
        <!-- Totals Card -->
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-calculator"></i> Totales</h5>
          </div>
          <div class="card-body total-panel">
            <div class="d-flex justify-content-between mb-2">
              <span>Subtotal:</span>
              <span class="fw-bold">S/ <span id="subtotalAmount">0.00</span></span>
            </div>
            <div class="d-flex justify-content-between mb-2">
              <span>Descuento:</span>
              <div class="input-group input-group-sm" style="width: 150px;">
                <span class="input-group-text">S/</span>
                <input type="number" 
                       id="discountAmount" 
                       class="form-control" 
                       value="0" 
                       min="0" 
                       step="0.01"
                       onchange="updateTotals()">
              </div>
            </div>
            
            <!-- Birthday Discount Button (hidden by default) -->
            <div id="birthdayDiscountContainer" class="mb-2" style="display: none;">
              <button type="button" 
                      class="btn btn-sm btn-warning w-100" 
                      onclick="applyBirthdayDiscount()">
                <i class="bi bi-gift"></i> Aplicar Descuento Cumpleaños
              </button>
            </div>
            
            <hr>
            <div class="d-flex justify-content-between align-items-center">
              <span class="h5 mb-0">TOTAL:</span>
              <span class="total-amount">S/ <span id="totalAmount">0.00</span></span>
            </div>
          </div>
        </div>
        
        <!-- Actions Card -->
        <div class="card">
          <div class="card-body">
            <button type="button" 
                    id="btnConfirmSale" 
                    class="btn btn-success btn-lg w-100 mb-2" 
                    onclick="confirmSale()"
                    disabled>
              <i class="bi bi-check-circle"></i> Confirmar Venta
            </button>
            <button type="button" 
                    class="btn btn-outline-secondary w-100" 
                    onclick="cancelSale()">
              <i class="bi bi-x-circle"></i> Cancelar
            </button>
          </div>
        </div>
        
      </div>
      
    </div>
    
  </div>
  
  
  <script>
    // Global variables
    let cart = [];
    let storeId = 'STORE_MUJERES'; // Default store
    let warehouseId = 'Mujeres'; // Default warehouse (debe coincidir con INV_Stock.warehouse_id)
    let userId = '<?= userEmail ?>';
    let userName = '<?= userName ?>';
    
    $(document).ready(function() {
      // Set user info
      $('#userName').text(userName || 'Usuario');
      $('#storeName').text(getStoreName(storeId));
      
      // Load clients for credit sales
      loadClients();
      
      // Handle sale type change
      $('input[name="saleType"]').change(function() {
        const saleType = $(this).val();
        if (saleType === 'CREDITO') {
          $('#clientSelection').show();
          $('#installmentsSelection').show();
        } else {
          $('#clientSelection').hide();
          $('#installmentsSelection').hide();
          // Hide birthday alert when switching to cash
          $('#birthdayAlert').hide();
        }
      });
      
      // Handle client selection change
      $('#clientSelect').change(function() {
        const clientId = $(this).val();
        if (clientId) {
          checkClientBirthday(clientId);
        } else {
          $('#birthdayAlert').hide();
        }
      });
      
      // Handle Enter key in search
      $('#productSearch').keypress(function(e) {
        if (e.which === 13) {
          searchProduct();
        }
      });
      
      // NUEVO: Búsqueda automática mientras escribe (con debounce)
      let searchTimeout;
      $('#productSearch').on('input', function() {
        clearTimeout(searchTimeout);
        const query = $(this).val().trim();
        
        if (query.length >= 2) {
          // Esperar 500ms después de que el usuario deje de escribir
          searchTimeout = setTimeout(function() {
            searchProduct();
          }, 500);
        } else if (query.length === 0) {
          // Ocultar resultados si el campo está vacío
          $('#searchResults').hide();
        }
      });
    });
    
    function getStoreName(storeId) {
      const storeNames = {
        'STORE_MUJERES': 'Mujeres',
        'STORE_HOMBRES': 'Hombres'
      };
      return storeNames[storeId] || storeId;
    }
    
    function searchProduct() {
      const query = $('#productSearch').val().trim();
      
      if (!query) {
        alert('Por favor ingrese un código de barras o nombre de producto');
        return;
      }
      
      // Show loading
      $('#searchResults').show();
      $('#searchResultsList').html('<div class="text-center py-3"><div class="spinner-border" role="status"></div></div>');
      
      // Call server to search products
      google.script.run
        .withSuccessHandler(function(response) {
          if (response.success) {
            displaySearchResults(response.data);
          } else {
            alert('Error al buscar productos: ' + response.error);
            $('#searchResults').hide();
          }
        })
        .withFailureHandler(function(error) {
          alert('Error al buscar productos: ' + error.message);
          $('#searchResults').hide();
        })
        .searchProducts(query);
    }
    
    function displaySearchResults(products) {
      if (!products || products.length === 0) {
        $('#searchResultsList').html('<div class="list-group-item text-center text-muted">No se encontraron productos</div>');
        return;
      }
      
      let html = '';
      products.forEach(function(product) {
        // Obtener stock actual del almacén
        const stock = product.stock || 0;
        const stockBadge = stock > 0 
          ? `<span class="badge bg-success">Stock: ${stock}</span>` 
          : `<span class="badge bg-danger">Sin Stock</span>`;
        
        // Construir información del producto
        const category = product.category || 'Sin categoría';
        const size = product.size || '';
        const color = product.color || '';
        const brand = product.brand_name || '';
        const line = product.line_name || '';
        
        // Construir detalles adicionales
        let details = [];
        if (category) details.push('Categoría: ' + category);
        if (line) details.push('Línea: ' + line);
        if (brand) details.push('Marca: ' + brand);
        if (size) details.push('Talla: ' + size);
        if (color) details.push('Color: ' + color);
        
        const detailsText = details.join(' | ');
        
        html += `
          <a href="#" class="list-group-item list-group-item-action ${stock <= 0 ? 'disabled' : ''}" onclick="${stock > 0 ? `addProductToCart('${product.id}'); return false;` : 'return false;'}">
            <div class="d-flex w-100 justify-content-between align-items-start">
              <div class="flex-grow-1">
                <h6 class="mb-1">${product.name}</h6>
                <p class="mb-1 small">${product.description || ''}</p>
                <small class="text-muted">Código: ${product.barcode}</small><br>
                <small class="text-muted">${detailsText}</small>
              </div>
              <div class="text-end">
                <div class="mb-1"><span class="badge bg-primary">S/ ${parseFloat(product.price || 0).toFixed(2)}</span></div>
                <div>${stockBadge}</div>
              </div>
            </div>
          </a>
        `;
      });
      
      $('#searchResultsList').html(html);
    }
    
    function addProductToCart(productId) {
      // Hide search results
      $('#searchResults').hide();
      $('#productSearch').val('');
      
      // Call server to get product details and add to cart
      google.script.run
        .withSuccessHandler(function(response) {
          if (response.success) {
            const cartItem = response.data;
            
            // Check if product already in cart
            const existingIndex = cart.findIndex(item => item.productId === cartItem.productId);
            
            if (existingIndex >= 0) {
              // Increment quantity
              cart[existingIndex].quantity += 1;
              cart[existingIndex].subtotal = cart[existingIndex].quantity * cart[existingIndex].unitPrice;
            } else {
              // Add new item
              cart.push(cartItem);
            }
            
            renderCart();
            updateTotals();
          } else {
            alert('Error al agregar producto: ' + response.error);
          }
        })
        .withFailureHandler(function(error) {
          alert('Error al agregar producto: ' + error.message);
        })
        .addItemToCart(productId, 1, warehouseId);
    }
    
    function renderCart() {
      if (cart.length === 0) {
        $('#cartItems').html(`
          <div class="text-center text-muted py-5">
            <i class="bi bi-cart-x" style="font-size: 3rem;"></i>
            <p class="mt-2">El carrito está vacío</p>
            <p class="small">Escanea o busca productos para agregar</p>
          </div>
        `);
        $('#btnConfirmSale').prop('disabled', true);
        return;
      }
      
      let html = '';
      cart.forEach(function(item, index) {
        html += `
          <div class="cart-item">
            <div class="d-flex justify-content-between align-items-start">
              <div class="flex-grow-1">
                <h6 class="mb-1">${item.productName}</h6>
                <p class="mb-1 small text-muted">S/ ${parseFloat(item.unitPrice).toFixed(2)} x ${item.quantity}</p>
              </div>
              <div class="text-end">
                <div class="fw-bold mb-2">S/ ${parseFloat(item.subtotal).toFixed(2)}</div>
                <div class="btn-group btn-group-sm">
                  <button type="button" class="btn btn-outline-secondary" onclick="decrementQuantity(${index})">
                    <i class="bi bi-dash"></i>
                  </button>
                  <button type="button" class="btn btn-outline-secondary" onclick="incrementQuantity(${index})">
                    <i class="bi bi-plus"></i>
                  </button>
                  <button type="button" class="btn btn-outline-danger" onclick="removeItem(${index})">
                    <i class="bi bi-trash"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        `;
      });
      
      $('#cartItems').html(html);
      $('#btnConfirmSale').prop('disabled', false);
    }
    
    function incrementQuantity(index) {
      cart[index].quantity += 1;
      cart[index].subtotal = cart[index].quantity * cart[index].unitPrice;
      renderCart();
      updateTotals();
    }
    
    function decrementQuantity(index) {
      if (cart[index].quantity > 1) {
        cart[index].quantity -= 1;
        cart[index].subtotal = cart[index].quantity * cart[index].unitPrice;
        renderCart();
        updateTotals();
      }
    }
    
    function removeItem(index) {
      cart.splice(index, 1);
      renderCart();
      updateTotals();
    }
    
    function clearCart() {
      if (cart.length === 0) return;
      
      if (confirm('¿Está seguro de vaciar el carrito?')) {
        cart = [];
        renderCart();
        updateTotals();
      }
    }
    
    function updateTotals() {
      let subtotal = 0;
      cart.forEach(function(item) {
        subtotal += item.subtotal;
      });
      
      const discount = parseFloat($('#discountAmount').val()) || 0;
      const total = Math.max(0, subtotal - discount);
      
      $('#subtotalAmount').text(subtotal.toFixed(2));
      $('#totalAmount').text(total.toFixed(2));
    }
    
    function confirmSale() {
      if (cart.length === 0) {
        alert('El carrito está vacío');
        return;
      }
      
      const saleType = $('input[name="saleType"]:checked').val();
      
      // Validate credit sale
      if (saleType === 'CREDITO') {
        const clientId = $('#clientSelect').val();
        if (!clientId) {
          alert('Por favor seleccione un cliente para venta a crédito');
          return;
        }
      }
      
      if (!confirm('¿Confirmar venta por S/ ' + $('#totalAmount').text() + '?')) {
        return;
      }
      
      // Disable button to prevent double-click
      $('#btnConfirmSale').prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> Procesando...');
      
      // Prepare sale data
      const saleData = {
        storeId: storeId,
        warehouseId: warehouseId,
        userId: userId,
        clientId: saleType === 'CREDITO' ? $('#clientSelect').val() : '',
        saleType: saleType,
        items: cart,
        discount: parseFloat($('#discountAmount').val()) || 0,
        installments: saleType === 'CREDITO' ? parseInt($('#installmentsSelect').val()) : 0
      };
      
      // Generate requestId for idempotency
      const requestId = 'req-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
      
      // Call server to create sale
      google.script.run
        .withSuccessHandler(function(response) {
          if (response.success) {
            const saleId = response.data.sale.id;
            const saleNumber = response.data.sale.sale_number;
            const total = response.data.totals.total.toFixed(2);
            
            alert('¡Venta registrada exitosamente!\n\nNúmero de venta: ' + saleNumber + '\nTotal: S/ ' + total);
            
            // Clear cart and reset form
            cart = [];
            renderCart();
            updateTotals();
            $('#discountAmount').val(0);
            $('#saleTypeContado').prop('checked', true);
            $('#clientSelection').hide();
            $('#installmentsSelection').hide();
            
            // Ask if want to print ticket
            if (confirm('¿Desea imprimir el ticket?')) {
              printTicket(saleId);
            }
            
            // Ask if want to generate invoice
            if (confirm('¿Desea generar factura electrónica?')) {
              generateInvoice(saleId);
            }
          } else {
            alert('Error al registrar venta: ' + response.error);
          }
          
          $('#btnConfirmSale').prop('disabled', false).html('<i class="bi bi-check-circle"></i> Confirmar Venta');
        })
        .withFailureHandler(function(error) {
          alert('Error al registrar venta: ' + error.message);
          $('#btnConfirmSale').prop('disabled', false).html('<i class="bi bi-check-circle"></i> Confirmar Venta');
        })
        .createSale(saleData, requestId);
    }
    
    function cancelSale() {
      if (cart.length === 0) {
        // CRÍTICO: Usar buildUrlWithSession para preservar sesión
        if (window.buildUrlWithSession) {
          window.location.href = window.buildUrlWithSession('dashboard');
        } else {
          // Fallback si la función no está disponible
          const sessionUser = '<?= sessionUser ?>';
          const sessionToken = '<?= sessionToken ?>';
          window.location.href = '?page=dashboard&user=' + encodeURIComponent(sessionUser) + '&token=' + encodeURIComponent(sessionToken);
        }
        return;
      }
      
      if (confirm('¿Está seguro de cancelar la venta?')) {
        cart = [];
        renderCart();
        updateTotals();
      }
    }
    
    function loadClients() {
      google.script.run
        .withSuccessHandler(function(response) {
          if (response.success) {
            let html = '<option value="">Seleccionar cliente...</option>';
            response.data.forEach(function(client) {
              html += `<option value="${client.id}">${client.name} - ${client.dni}</option>`;
            });
            $('#clientSelect').html(html);
          }
        })
        .withFailureHandler(function(error) {
          console.error('Error loading clients:', error);
        })
        .getClients();
    }
    
    function openScanner() {
      // CRÍTICO: Usar la URL completa del script desde window.SCRIPT_URL
      const sessionUser = '<?= sessionUser ?>';
      const sessionToken = '<?= sessionToken ?>';
      
      // Construir URL completa con parámetros de sesión
      let scannerUrl = window.SCRIPT_URL || '<?= scriptUrl ?>';
      scannerUrl += '?page=barcode-scanner';
      scannerUrl += '&user=' + encodeURIComponent(sessionUser);
      scannerUrl += '&token=' + encodeURIComponent(sessionToken);
      
      console.log('Abriendo escáner en:', scannerUrl);
      
      // Open scanner in a popup window
      const scannerWindow = window.open(
        scannerUrl,
        'BarcodeScanner',
        'width=800,height=600,resizable=yes,scrollbars=yes'
      );
      
      if (!scannerWindow) {
        alert('No se pudo abrir el escáner. Por favor permita ventanas emergentes en su navegador.');
        return;
      }
      
      // Listen for barcode from scanner window
      window.addEventListener('message', function(event) {
        if (event.data && event.data.type === 'barcode-scanned') {
          const barcode = event.data.barcode;
          console.log('Barcode received:', barcode);
          
          // Set barcode in search field and search
          $('#productSearch').val(barcode);
          searchProduct();
        }
      });
    }
    
    function openNewClient() {
      // SOLUCIÓN: Usar modal de Bootstrap en lugar de abrir nueva ventana
      // Crear modal dinámicamente
      const modalHtml = `
        <div class="modal fade" id="newClientModal" tabindex="-1" aria-labelledby="newClientModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="newClientModalLabel">
                  <i class="bi bi-person-plus"></i> Nuevo Cliente
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <form id="quickClientForm">
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label for="clientName" class="form-label">Nombre Completo *</label>
                      <input type="text" class="form-control" id="clientName" required>
                    </div>
                    <div class="col-md-6 mb-3">
                      <label for="clientDNI" class="form-label">DNI *</label>
                      <input type="text" class="form-control" id="clientDNI" required maxlength="8" pattern="[0-9]{8}">
                    </div>
                  </div>
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label for="clientPhone" class="form-label">Teléfono *</label>
                      <input type="tel" class="form-control" id="clientPhone" required>
                    </div>
                    <div class="col-md-6 mb-3">
                      <label for="clientEmail" class="form-label">Email</label>
                      <input type="email" class="form-control" id="clientEmail">
                    </div>
                  </div>
                  <div class="mb-3">
                    <label for="clientAddress" class="form-label">Dirección</label>
                    <input type="text" class="form-control" id="clientAddress">
                  </div>
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label for="clientBirthday" class="form-label">Fecha de Nacimiento</label>
                      <input type="date" class="form-control" id="clientBirthday">
                    </div>
                  </div>
                </form>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                  <i class="bi bi-x-circle"></i> Cancelar
                </button>
                <button type="button" class="btn btn-primary" onclick="saveQuickClient()">
                  <i class="bi bi-save"></i> Guardar Cliente
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      // Remover modal anterior si existe
      $('#newClientModal').remove();
      
      // Agregar modal al body
      $('body').append(modalHtml);
      
      // Mostrar modal
      const modal = new bootstrap.Modal(document.getElementById('newClientModal'));
      modal.show();
    }
    
    // Función para guardar cliente rápido
    window.saveQuickClient = function() {
      const clientData = {
        name: $('#clientName').val().trim(),
        dni: $('#clientDNI').val().trim(),
        phone: $('#clientPhone').val().trim(),
        email: $('#clientEmail').val().trim(),
        address: $('#clientAddress').val().trim(),
        birthday: $('#clientBirthday').val()
      };
      
      // Validar campos requeridos
      if (!clientData.name || !clientData.dni || !clientData.phone) {
        alert('Por favor complete todos los campos requeridos (*)');
        return;
      }
      
      // Validar DNI
      if (!/^[0-9]{8}$/.test(clientData.dni)) {
        alert('El DNI debe tener 8 dígitos');
        return;
      }
      
      // Mostrar loading
      const saveBtn = $('#newClientModal .btn-primary');
      const originalText = saveBtn.html();
      saveBtn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm"></span> Guardando...');
      
      // Llamar al servidor para crear cliente
      google.script.run
        .withSuccessHandler(function(response) {
          if (response.success) {
            // Cerrar modal
            bootstrap.Modal.getInstance(document.getElementById('newClientModal')).hide();
            
            // Recargar lista de clientes
            loadClients();
            
            // Seleccionar el nuevo cliente automáticamente
            setTimeout(function() {
              $('#clientSelect').val(response.data.id);
              alert('Cliente creado exitosamente: ' + clientData.name);
            }, 500);
          } else {
            alert('Error al crear cliente: ' + response.error);
            saveBtn.prop('disabled', false).html(originalText);
          }
        })
        .withFailureHandler(function(error) {
          alert('Error al crear cliente: ' + error.message);
          saveBtn.prop('disabled', false).html(originalText);
        })
        .createClientQuick(clientData);
    };
    
    function printTicket(saleId) {
      // Call server to generate ticket HTML
      google.script.run
        .withSuccessHandler(function(response) {
          if (response.success) {
            // Open ticket in new window and print
            const ticketWindow = window.open('', 'Ticket', 'width=400,height=600');
            ticketWindow.document.write(response.data.html);
            ticketWindow.document.close();
          } else {
            alert('Error al generar ticket: ' + response.error);
          }
        })
        .withFailureHandler(function(error) {
          alert('Error al generar ticket: ' + error.message);
        })
        .generateTicket(saleId);
    }
    
    function generateInvoice(saleId) {
      // Show loading
      const loadingMsg = 'Generando factura electrónica...';
      console.log(loadingMsg);
      
      // Call server to generate invoice
      google.script.run
        .withSuccessHandler(function(response) {
          if (response.success) {
            const invoice = response.data;
            
            // Ask for client email to send invoice
            const clientEmail = prompt('Factura generada exitosamente.\n\nNúmero: ' + invoice.invoice_number + '\n\n¿Desea enviar la factura por email?\nIngrese el email del cliente (o deje en blanco para omitir):');
            
            if (clientEmail && clientEmail.trim() !== '') {
              sendInvoiceByEmail(invoice.id, clientEmail.trim());
            } else {
              alert('Factura generada. Puede consultarla en la sección de Facturas.');
            }
          } else {
            alert('Error al generar factura: ' + response.error);
          }
        })
        .withFailureHandler(function(error) {
          alert('Error al generar factura: ' + error.message);
        })
        .generateInvoiceForSale(saleId);
    }
    
    function sendInvoiceByEmail(invoiceId, email) {
      console.log('Enviando factura a:', email);
      
      google.script.run
        .withSuccessHandler(function(response) {
          if (response.success) {
            alert('Factura enviada exitosamente a ' + email);
          } else {
            alert('Error al enviar factura: ' + response.error);
          }
        })
        .withFailureHandler(function(error) {
          alert('Error al enviar factura: ' + error.message);
        })
        .sendInvoiceEmail(invoiceId, email);
    }
    
    function checkClientBirthday(clientId) {
      console.log('Verificando cumpleaños del cliente:', clientId);
      
      google.script.run
        .withSuccessHandler(function(response) {
          if (response.success) {
            const result = response.data;
            
            if (result.isBirthday) {
              // Mostrar alerta de cumpleaños
              const alertHtml = `
                <div class="alert alert-success alert-dismissible fade show mb-4" role="alert">
                  <h5 class="alert-heading">
                    <i class="bi bi-gift-fill"></i> ¡Feliz Cumpleaños!
                  </h5>
                  <p class="mb-0">
                    <strong>${result.client.name}</strong> está de cumpleaños hoy. 
                    Recuerda aplicar el descuento especial o entregar un obsequio.
                  </p>
                  <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
              `;
              $('#birthdayAlert').html(alertHtml).show();
              
              // Mostrar botón de descuento de cumpleaños
              $('#birthdayDiscountContainer').show();
            } else {
              // Ocultar alerta y botón si no es cumpleaños
              $('#birthdayAlert').hide();
              $('#birthdayDiscountContainer').hide();
            }
          } else {
            console.error('Error al verificar cumpleaños:', response.error);
          }
        })
        .withFailureHandler(function(error) {
          console.error('Error al verificar cumpleaños:', error.message);
        })
        .checkClientBirthday(clientId);
    }
    
    function applyBirthdayDiscount() {
      const clientId = $('#clientSelect').val();
      
      if (!clientId) {
        alert('Por favor seleccione un cliente');
        return;
      }
      
      const subtotal = parseFloat($('#subtotalAmount').text()) || 0;
      
      if (subtotal <= 0) {
        alert('El carrito está vacío');
        return;
      }
      
      // Llamar al backend para calcular descuento
      google.script.run
        .withSuccessHandler(function(response) {
          if (response.success) {
            const result = response.data;
            
            // Aplicar descuento
            $('#discountAmount').val(result.discountAmount.toFixed(2));
            updateTotals();
            
            // Mostrar mensaje
            alert(`Descuento de cumpleaños aplicado: ${result.discountPercent}%\nDescuento: S/ ${result.discountAmount.toFixed(2)}`);
            
            // Ocultar botón después de aplicar
            $('#birthdayDiscountContainer').hide();
          } else {
            alert('Error al aplicar descuento: ' + response.error);
          }
        })
        .withFailureHandler(function(error) {
          alert('Error al aplicar descuento: ' + error.message);
        })
        .applyBirthdayDiscountWrapper(subtotal, clientId, userId);
    }
  </script>
  
</body>
</html>
